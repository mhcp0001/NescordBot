name: CI Cogs Bot Test

on:
  push:
    branches: [ 'feature/108-gemini-audio-migration' ]
  pull_request:
    branches: [ 'feature/108-gemini-audio-migration' ]

jobs:
  test-cogs-bot-only:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    strategy:
      matrix:
        python-version: ["3.11"]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install Poetry
      uses: snok/install-poetry@v1
      with:
        version: latest
        virtualenvs-create: true
        virtualenvs-in-project: true
        installer-parallel: true

    - name: Install dependencies
      run: poetry install --no-interaction

    - name: Set up test environment
      run: |
        mkdir -p data
        mkdir -p logs
        cp .env.example .env.test
        echo "DISCORD_TOKEN=MTA1234567890123456.GH7890.abcdefghijklmnop123456789012345678901234" >> .env.test
        echo "OPENAI_API_KEY=sk-abcdef1234567890abcdef1234567890abcdef1234567890ab" >> .env.test
        echo "LOG_LEVEL=DEBUG" >> .env.test

    - name: Run cogs-bot tests only
      env:
        DISCORD_TOKEN: MTA1234567890123456.GH7890.abcdefghijklmnop123456789012345678901234
        OPENAI_API_KEY: sk-abcdef1234567890abcdef1234567890abcdef1234567890ab
        LOG_LEVEL: DEBUG
      run: |
        poetry run pytest \
          tests/cogs/test_pkm.py \
          tests/test_admin_cog.py \
          tests/test_admin_functionality.py \
          tests/test_bot.py \
          tests/test_bot_integration.py \
          tests/test_cogs_general.py \
          tests/test_text_cog.py \
          tests/test_text_integration.py \
          --forked \
          --tb=short \
          -m "not slow and not network" \
          --timeout=60 \
          --timeout-method=thread \
          -v
