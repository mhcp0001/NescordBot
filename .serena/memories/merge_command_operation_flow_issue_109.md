# /merge コマンド操作フロー - Issue #109実装用

## コマンド概要
PKMシステム内のノートを意味的に統合し、新しい知見を生成するDiscordスラッシュコマンド

## 基本操作フロー

### Phase 1: 初期ノート選択
```
/merge [note1] [note2] [note3]
```
- **ユーザー操作**: 1-3個の統合したいノートを指定
- **入力方法**: ノートタイトル or ファイル名 (部分一致対応)
- **バリデーション**: 指定されたノートの存在確認

### Phase 2: AI関連ノート提案
```
🤖 選択されたノート:
• [note1] - "会議録 2024-03-15"
• [note2] - "プロジェクト要件定義"

🔍 関連する可能性のあるノート:
• [関連ノート1] - 類似度: 85%
• [関連ノート2] - 類似度: 78%
• [関連ノート3] - 類似度: 72%

追加しますか？
[✅ すべて追加] [🔧 個別選択] [❌ スキップ]
```

#### AI提案ロジック:
1. **ベクトル類似度検索**: Gemini Embedding APIでセマンティック類似度計算
2. **キーワード共通性**: 重要語句の重複分析
3. **時系列関連性**: 作成日時・更新日時の近接性
4. **参照関係**: ノート間のクロスリファレンス検出

### Phase 3: 統合対象確定
```
📝 統合対象ノート (最終確認):
• [note1] - "会議録 2024-03-15"
• [note2] - "プロジェクト要件定義"
• [関連ノート1] - "技術仕様書v1.2"

[🚀 統合開始] [✏️ 編集] [❌ キャンセル]
```

### Phase 4: AI統合処理
```
⏳ ノート統合中...
🔄 内容分析中... (1/4)
🔄 構造化中... (2/4)
🔄 統合文書生成中... (3/4)
🔄 メタデータ更新中... (4/4)
✅ 統合完了!
```

#### 内部処理フロー:
1. **コンテンツ抽出**: 各ノートの本文・メタデータ取得
2. **セマンティック分析**: Gemini APIで主要テーマ・概念抽出
3. **構造統合**: 論理的な文書構造生成
4. **重複除去**: 内容の重複検出・統合
5. **新規文書生成**: マークダウン形式での統合結果作成

### Phase 5: 結果表示・保存
```
✨ 統合結果:

📄 **新規統合ノート**: "プロジェクト全体像_統合版_2024-03-20"

📊 **統合サマリー**:
• 統合ノート数: 3個
• 総文字数: 1,250文字 → 800文字 (36%圧縮)
• 新規発見された関連性: 2件
• 生成された洞察: 4件

🔗 **発見された新しい知見**:
• 要件定義と技術仕様の整合性課題
• 会議決定事項の実装への影響分析

[💾 Obsidianに保存] [📤 エクスポート] [🔄 再統合] [❌ 削除]
```

## UI/UX設計原則

### 1. **段階的情報開示**
- 一度に表示する選択肢を制限 (認知負荷軽減)
- ユーザーの意図に応じた詳細情報展開

### 2. **AI提案の透明性**
- 関連度スコア表示で判断根拠を明示
- 「なぜこのノートが関連するか」の説明機能

### 3. **セレンディピティ促進**
- 予想外の関連性発見をサポート
- 「面白い組み合わせ」の積極提案

### 4. **操作の可逆性**
- 各段階でのキャンセル・修正機能
- 統合結果の編集・再処理機能

## エラーハンドリング

### よくあるエラーケース:
1. **ノート不存在**: 「指定されたノートが見つかりません」
2. **権限不足**: 「このノートにアクセス権限がありません」
3. **API制限**: 「一時的にサービスが利用できません。しばらく後にお試しください」
4. **統合失敗**: 「ノートの構造が複雑すぎて統合できませんでした」

## 実装技術仕様

### 必要なサービス:
- **GeminiTranscriptionService**: セマンティック分析
- **ObsidianGitHubService**: ノート読み込み・保存
- **NoteProcessingService**: テキスト処理・統合

### データフロー:
```
Discord Input → ノート特定 → AI分析 → 関連ノート検索 →
ユーザー確認 → 統合処理 → 結果生成 → Obsidian保存
```

### パフォーマンス要件:
- 初期応答: 3秒以内
- AI分析: 10秒以内
- 統合処理: 30秒以内
- 最大同時処理数: 3件

## 将来拡張案

### Phase 2機能:
- **テンプレート統合**: 特定の統合パターンをテンプレート化
- **バージョン管理**: 統合結果の履歴管理
- **協調統合**: 複数ユーザーでの共同統合作業
- **自動統合**: 定期的な関連ノート統合提案

### Phase 3機能:
- **ビジュアル統合**: マインドマップ・図表生成
- **多言語対応**: 異なる言語のノート統合
- **外部連携**: Notion・Roam Research等との統合

## 成功メトリクス

### 定量指標:
- コマンド利用頻度
- 統合成功率 (95%以上)
- ユーザー満足度スコア
- 平均処理時間

### 定性指標:
- 新しい洞察の発見頻度
- ノート整理効率の向上
- PKMワークフローへの組み込み度合い

---

**次の実装フェーズ**: Issue #109でこのフローに基づいたDiscord Cogの実装を開始
