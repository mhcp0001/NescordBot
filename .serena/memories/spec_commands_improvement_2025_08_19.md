# 仕様書駆動開発スラッシュコマンド改善記録 - 2025-08-19

## 改善の背景

Task 3.7.1-3.7.2の開発セッションで得られた重要な学びを基に、既存の仕様書駆動開発スラッシュコマンドを大幅に改善しました。

### 改善のきっかけとなった問題と解決パターン
1. **pathvalidate依存関係欠落問題** → 事前の依存関係チェックパターン
2. **Git操作テスト失敗** → モック設定の精密化パターン
3. **非同期テスト不安定性** → 段階的検証パターン

これらの経験から、問題の早期発見と段階的解決の重要性が明らかになりました。

## 改善内容詳細

### 1. 基本コマンドの強化

#### `/requirements` - 要求分析・仕様策定
**従来**: 基本的な要求整理のみ
**改善後**: 5ステップの包括的プロセス
1. 要求収集 - ユーザー要求の体系的整理
2. 類似事例調査 - WebSearchでの類似実装調査
3. Gemini検証 - 要求の妥当性と網羅性を多角的に検証
4. 制約分析 - 技術的・運用的制約の特定
5. TodoWrite統合 - 自動的なタスクリスト作成と管理開始

**新機能**:
- WebSearch連携による実例収集
- Geminiによる要求妥当性の客観的検証
- TodoWriteとの自動統合

#### `/design` - 技術設計・アーキテクチャ設計
**従来**: 基本的な設計作成
**改善後**: 5フェーズ設計プロセス

**Phase 1: 初期設計** - Claude主導での設計素案作成
**Phase 2: 外部調査** - WebFetch/WebSearchでの実装パターン調査
**Phase 3: 多角的検証** - Geminiによる設計妥当性とセキュリティ検証
**Phase 4: 問題パターンチェック** - 既知問題パターンとの照合
**Phase 5: 改善設計** - 検証結果を基にした設計改良

**問題パターンライブラリ**:
- 依存関係欠落パターン（今回の経験から追加）
- モック設定ミスパターン（今回の経験から追加）
- 非同期処理不安定パターン（今回の経験から追加）
- セキュリティ脆弱性パターン

#### `/tasks` - タスク分解・実装計画
**従来**: 基本的なタスク分解
**改善後**: 改善された5段階分解プロセス

1. **機能分解**: 設計を実装可能な単位に分解
2. **依存関係分析**: タスク間の依存関係を自動検出
3. **優先度評価**: リスク・影響度による自動優先順位付け
4. **テスト戦略**: 各タスクのテスト手法を事前定義
5. **品質チェックポイント**: 段階的検証ポイントの設定

**TodoWrite深度統合**:
- タスクの自動的なin_progress/completed管理
- 問題発生時の自動サブタスク作成
- 進捗メトリクスの自動追跡

### 2. 新規補助コマンドの追加

#### `/validate` - 段階的品質検証
**目的**: 今回のCI/CD問題から学んだ段階的検証の実現
**実行内容**:
- Step 1: 構文チェック（black, mypy, isort）
- Step 2: 単体テスト（個別機能検証）
- Step 3: 統合テスト（機能間連携検証）
- Step 4: CI/CD検証（全体品質確認）

#### `/troubleshoot` - 問題パターン診断
**目的**: 今回遭遇した問題パターンの体系化と自動診断
**診断パターン**:
- **依存関係問題**: ModuleNotFoundError, パッケージ欠落
- **テスト失敗**: AssertionError, モック設定ミス
- **非同期処理**: タイムアウト、リソースリーク
- **Git操作**: マージコンフリクト、ブランチ問題

#### `/test-strategy` - テスト戦略自動生成
**目的**: 今回のモック設定問題から学んだテスト戦略の事前設計
**生成内容**:
1. **実装メソッド分析**: 対象コードのロジック解析
2. **モック設定**: 必要なモック設定の自動特定
3. **エッジケース**: 境界値・異常系ケースの洗い出し
4. **非同期安定化**: タイムアウト・クリーンアップパターン適用

### 3. ベストプラクティスの体系化

#### 問題解決協力パターン
Claude + Gemini協力の効果的パターンを標準化：
1. **Claude主導分析**: まずClaude単独で徹底的に問題を分析
2. **Gemini多角検証**: 分析結果をGeminiで客観的に検証
3. **証拠ベース修正**: ログとテスト結果に基づく確実な判断
4. **段階的解決**: 複数問題を一度に扱わず、順次確実に解決

#### テスト安定化パターン
今回の経験から得られたテストの安定化手法：
- **モック精度**: 実装ロジックに基づいた正確なモック設定
- **非同期処理**: タイムアウト保護と適切なクリーンアップ
- **リソース管理**: try-finallyブロックでの確実なリソース解放
- **並列実行**: pytest-xdistでの高速テスト実行

#### 品質メトリクス追跡
継続的品質向上のための指標：
- **カバレッジ維持**: 60%以上のテストカバレッジ継続
- **問題解決時間**: パターンマッチングによる効率化
- **CI成功率**: 段階的品質チェックによる安定化
- **技術的負債**: 定期的なコード品質評価

### 4. 統合ワークフローの確立

```
1. `/requirements` → ユーザー要求の体系的整理 + Gemini検証
2. `/design` → 5フェーズ設計プロセス + 問題パターン照合
3. `/tasks` → 詳細タスク分解 + TodoWrite自動管理
4. 実装中: `/validate`, `/troubleshoot`, `/test-strategy` を適宜使用
5. 完了時: 全体品質検証とパターンライブラリ更新
```

## 技術的実装詳細

### 問題パターンライブラリの構造
```python
# 依存関係欠落パターン例
{
    "pattern": "ModuleNotFoundError",
    "symptoms": ["import error", "package not found"],
    "solution": "Check pyproject.toml dependencies",
    "prevention": "Add dependency check in /design phase"
}

# モック設定ミスパターン例
{
    "pattern": "Mock Configuration Error",
    "symptoms": ["AssertionError", "None != expected_value"],
    "solution": "Analyze implementation logic for proper mock setup",
    "prevention": "Use /test-strategy for mock design"
}
```

### Gemini協力パターンの標準化
```python
async def gemini_validation_pattern(analysis_result):
    # Phase 1: Claude分析完了
    claude_analysis = perform_analysis()

    # Phase 2: Gemini多角検証
    gemini_prompt = f"以下の分析結果を多角的に検証してください: {claude_analysis}"
    validation_result = await call_gemini(gemini_prompt)

    # Phase 3: 統合判断
    final_decision = integrate_results(claude_analysis, validation_result)
    return final_decision
```

## 期待される効果

### 短期効果（即座に実現）
1. **問題早期発見**: 既知パターンとの照合により問題を事前に特定
2. **設計品質向上**: 多角的検証による設計の客観性確保
3. **テスト安定性**: 実装ロジックに基づく正確なテスト設計

### 中期効果（数回の使用後）
1. **開発効率向上**: パターンライブラリの蓄積により問題解決時間短縮
2. **品質向上**: 段階的検証により全体的なコード品質向上
3. **学習効果**: 問題パターンの体系的理解による開発スキル向上

### 長期効果（継続使用後）
1. **プロジェクト成功率向上**: 問題の早期発見・解決による開発リスク低減
2. **知識資産化**: パターンライブラリが組織の知識資産として蓄積
3. **開発文化改善**: 段階的・協力的問題解決が標準的開発文化に

## 実装箇所
- **CLAUDE.md**: 420-532行に詳細な改善版スラッシュコマンド仕様を記載
- **改善前コマンド数**: 4個（/spec, /requirements, /design, /tasks）
- **改善後コマンド数**: 7個（基本3個 + 補助3個 + /spec統合）

## 今後の拡張予定
1. パターンライブラリの自動学習機能
2. メトリクス自動追跡システム
3. プロジェクト横断の知識共有機能
4. AI協力パターンの最適化

---
記録日時: 2025-08-19
改善者: Claude (based on session experience)
検証者: Gemini (multi-perspective validation)
統合者: Claude (final implementation)
