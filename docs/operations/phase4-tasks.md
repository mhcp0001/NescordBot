# Phase 4 タスクリスト - PKM機能「自分の第二の脳を育てるBot」

## 概要

このファイルは、`.tmp/tasks.md`で作成されたPhase 4 PKM機能のタスクを統合したものです。

- 総タスク数: 32
- 推定作業時間: 12週間 (480時間)
- 優先度: 高
- 開発方針: 段階的統合と既存資産活用による「Discord × AI × GitHub × 個人知識管理」統合システム

## ブランチ戦略

本プロジェクトではGitHub Flowを採用しています：
- **1タスク = 1ブランチ = 1PR** の原則
- 全てのブランチは`main`から作成
- 依存関係のあるタスクは、依存先がmainにマージされてから作業開始

## タスク一覧とブランチ戦略

### Phase 4.1: 基盤構築（週1-3）

#### Task 4.1.1: ServiceContainer Phase 4拡張

- [ ] Phase 4新規サービス用ServiceContainer拡張実装
- [ ] KnowledgeManager、EmbeddingService、ChromaDBService等の依存関係注入対応
- [ ] 既存サービスとの互換性維持確認
- [ ] 初期化順序とライフサイクル管理実装
- **完了条件**: Phase 4サービスが正常に登録・取得できること
- **依存**: なし
- **推定時間**: 8時間
- **ブランチ**: `refactor/service-container-phase4`

#### Task 4.1.2: BotConfig Gemini・ChromaDB設定追加

- [ ] Gemini API設定項目追加（api_key, monthly_limit等）
- [ ] ChromaDB設定項目追加（persist_directory, collection_name等）
- [ ] PKM機能設定項目追加（hybrid_search_alpha等）
- [ ] API移行モード設定（openai/gemini/hybrid）
- [ ] Pydantic バリデーション追加
- **完了条件**: 全Phase 4設定が環境変数から正常に読み込まれること
- **依存**: なし
- **推定時間**: 4時間
- **ブランチ**: `feature/config-phase4-settings`

#### Task 4.1.3: データベーススキーマ拡張

- [ ] knowledge_notes テーブル作成
- [ ] note_links テーブル作成
- [ ] token_usage テーブル作成
- [ ] 既存transcriptionsテーブル拡張（note_id, tags, links列追加）
- [ ] FTS5検索インデックス構築
- [ ] マイグレーション機能実装
- **完了条件**: 新規テーブルとインデックスが正常に作成されること
- **依存**: なし
- **推定時間**: 6時間
- **ブランチ**: `feature/database-schema-extension`

#### Task 4.1.4: TokenManager実装

- [ ] Gemini API月100万トークン制限管理実装
- [ ] 使用量記録・追跡機能
- [ ] 90%/95%/100%段階制限機能
- [ ] トークン消費量予測機能
- [ ] アラート・通知機能
- **完了条件**: トークン制限が正常に機能すること
- **依存**: Task 4.1.3
- **推定時間**: 8時間
- **ブランチ**: `feature/token-manager`

#### Task 4.1.5: EmbeddingService (Gemini API統合)

- [ ] Gemini API クライアント実装
- [ ] text-embedding-004 モデル統合
- [ ] バッチ埋め込み処理実装
- [ ] エラーハンドリング・リトライ機能
- [ ] キャッシュ機能実装
- **完了条件**: Gemini API埋め込み生成が正常に動作すること
- **依存**: Task 4.1.2, Task 4.1.4
- **推定時間**: 12時間
- **ブランチ**: `feature/gemini-embedding-service`

#### Task 4.1.6: ChromaDBService実装

- [ ] ChromaDB in-process統合実装
- [ ] PersistentClient初期化とコレクション管理
- [ ] ドキュメント追加・更新・削除機能
- [ ] ベクトル検索機能実装
- [ ] Railway永続化対応（Persistent Volumes）
- **完了条件**: ChromaDB操作が全て正常に動作すること
- **依存**: Task 4.1.2
- **推定時間**: 10時間
- **ブランチ**: `feature/chromadb-service`

#### Task 4.1.7: Railway Persistent Volumes設定・検証

- [ ] railway.toml設定更新
- [ ] Dockerfile永続化対応修正
- [ ] データディレクトリ権限設定
- [ ] 起動時整合性チェック実装
- [ ] バックアップ・復元機能基盤
- **完了条件**: Railway環境でデータが永続化されること
- **依存**: Task 4.1.6
- **推定時間**: 6時間
- **ブランチ**: `ci/railway-persistent-volumes`

#### Task 4.1.8: SyncManager基本機能

- [ ] SQLite-ChromaDB同期管理実装
- [ ] ノート変更時の自動同期
- [ ] データ整合性チェック機能
- [ ] 一括同期（bulk_sync）実装
- [ ] 同期エラー処理・復旧機能
- **完了条件**: SQLite-ChromaDB間のデータ同期が正常に動作すること
- **依存**: Task 4.1.3, Task 4.1.5, Task 4.1.6
- **推定時間**: 12時間
- **ブランチ**: `feature/sync-manager-basic`

### Phase 4.2: PKM機能実装（週4-6）

#### Task 4.2.1: KnowledgeManager中核実装

- [ ] 個人知識管理の中核クラス実装
- [ ] ノートCRUD操作（create_note, update_note, delete_note）
- [ ] リンク抽出機能（[[note_name]]パターン）
- [ ] タグ管理機能
- [ ] ObsidianGitHubService統合（GitHub保存）
- **完了条件**: 基本的なノート管理が全て動作すること
- **依存**: Task 4.1.1, Task 4.1.5, Task 4.1.6, Task 4.1.8
- **推定時間**: 16時間
- **ブランチ**: `feature/knowledge-manager-core`

#### Task 4.2.2: SearchEngine基本実装

- [ ] ベクトル検索機能実装
- [ ] FTS5キーワード検索機能実装
- [ ] 基本検索結果統合
- [ ] 検索結果ランキング機能
- [ ] 検索履歴管理
- **完了条件**: ベクトル・キーワード検索が正常に動作すること
- **依存**: Task 4.2.1
- **推定時間**: 12時間
- **ブランチ**: `feature/search-engine-basic`

#### Task 4.2.3: PKMCog基本コマンド実装

- [ ] /note コマンド実装（ノート作成）
- [ ] /search コマンド実装（基本検索）
- [ ] /list コマンド実装（ノート一覧）
- [ ] Discord UI実装（Embed, View）
- [ ] エラーハンドリング・ユーザーフィードバック
- **完了条件**: 基本PKMコマンドが全て動作すること
- **依存**: Task 4.2.1, Task 4.2.2
- **推定時間**: 14時間
- **ブランチ**: `feature/pkm-basic-commands`

#### Task 4.2.4: ハイブリッド検索実装

- [ ] RRF (Reciprocal Rank Fusion) アルゴリズム実装
- [ ] ベクトル・キーワード検索結果の重み付け統合
- [ ] 検索精度調整・チューニング機能
- [ ] 検索モード選択（vector/keyword/hybrid）
- [ ] パフォーマンス最適化
- **完了条件**: ハイブリッド検索で高精度な結果が得られること
- **依存**: Task 4.2.2
- **推定時間**: 10時間
- **ブランチ**: `feature/hybrid-search-rrf`

#### Task 4.2.5: ノートリンク機能実装

- [ ] [[note_name]]リンク解析・検証
- [ ] 双方向リンク管理
- [ ] リンク先ノート自動検索・提案
- [ ] リンクグラフ可視化（基本）
- [ ] 孤立ノート検出機能
- **完了条件**: ノート間リンクが正常に機能すること
- **依存**: Task 4.2.1
- **推定時間**: 8時間
- **ブランチ**: `feature/note-links`

#### Task 4.2.6: Gemini Audio API移行 (VoiceCog統合)

- [ ] Gemini 1.5 Pro音声転写統合
- [ ] OpenAI Whisper→Gemini移行実装
- [ ] アダプター層実装（段階的切り替え）
- [ ] VoicecogのGemini統合
- [ ] 音声→自動PKMノート化機能
- **完了条件**: Gemini音声転写が正常に動作すること
- **依存**: Task 4.1.5, Task 4.2.1
- **推定時間**: 10時間
- **ブランチ**: `feature/gemini-audio-migration`

### Phase 4.3: 高度機能・最適化（週7-9）

#### Task 4.3.1: /merge コマンド実装

- [ ] 複数ノート選択UI実装
- [ ] Gemini APIによる知的統合処理
- [ ] 類似ノート自動検出・提案
- [ ] 統合結果のプレビュー・編集機能
- [ ] 統合履歴管理
- **完了条件**: ノート統合が高品質で動作すること
- **依存**: Task 4.2.1, Task 4.2.4
- **推定時間**: 14時間
- **ブランチ**: `feature/merge-command`

#### Task 4.3.2: 自動タグ付け・カテゴリ化

- [ ] Gemini APIによる自動タグ抽出
- [ ] 既存タグとの統合・正規化
- [ ] カテゴリ階層管理
- [ ] タグ推薦システム
- [ ] タグベース検索フィルター
- **完了条件**: 自動タグ付けが実用的レベルで動作すること
- **依存**: Task 4.2.1
- **推定時間**: 10時間
- **ブランチ**: `feature/auto-tagging`

#### Task 4.3.3: Fleeting Note処理拡張

- [ ] 音声メッセージ自動PKM化
- [ ] FleetingNoteView拡張（PKM統合）
- [ ] 自動関連ノート検索・提案
- [ ] Fleeting→Permanent変換支援
- [ ] メタデータ自動抽出
- **完了条件**: 音声からのPKM化が自動で動作すること
- **依存**: Task 4.2.6, Task 4.3.2
- **推定時間**: 8時間
- **ブランチ**: `feature/enhanced-fleeting-notes`

#### Task 4.3.4: バッチ処理最適化

- [ ] 大量ノート一括埋め込み処理
- [ ] ChromaDBバッチ操作最適化
- [ ] メモリ使用量最適化
- [ ] 並列処理実装
- [ ] 処理進捗表示・キャンセル機能
- **完了条件**: 大量データ処理が効率的に動作すること
- **依存**: Task 4.2.1, Task 4.2.4
- **推定時間**: 8時間
- **ブランチ**: `refactor/batch-processing`

#### Task 4.3.5: API制限時フォールバック機能

- [ ] 段階的機能制限システム実装
- [ ] ローカルキャッシュ活用機能
- [ ] 使用量閾値監視・アラート
- [ ] 手動モード・緊急時対応
- [ ] 制限状況UI表示
- **完了条件**: API制限時でも基本機能が維持されること
- **依存**: Task 4.1.4
- **推定時間**: 10時間
- **ブランチ**: `feature/api-fallback-system`

### Phase 4.4: 品質保証・運用（週10-12）

#### Task 4.4.1: Phase4Monitor・メトリクス

- [ ] PKM機能専用監視システム実装
- [ ] トークン使用量・検索精度メトリクス
- [ ] システム健全性チェック
- [ ] パフォーマンス監視
- [ ] /stats コマンド実装（ダッシュボード）
- **完了条件**: 包括的な監視・メトリクス機能が動作すること
- **依存**: Task 4.1.4, Task 4.2.4
- **推定時間**: 8時間
- **ブランチ**: `feature/phase4-monitoring`

#### Task 4.4.2: AlertManager・通知システム

- [ ] アラート・通知システム実装
- [ ] トークン制限・システム異常通知
- [ ] Discord管理者通知機能
- [ ] アラート設定・閾値管理
- [ ] 通知履歴・分析機能
- **完了条件**: 重要なシステム状態が適切に通知されること
- **依存**: Task 4.4.1
- **推定時間**: 6時間
- **ブランチ**: `feature/alert-manager`

#### Task 4.4.3: BackupManager実装

- [ ] 日次自動バックアップシステム
- [ ] SQLite・ChromaDBデータバックアップ
- [ ] バックアップ世代管理・クリーンアップ
- [ ] 災害復旧手順実装
- [ ] バックアップ整合性チェック
- **完了条件**: データバックアップ・復旧が確実に動作すること
- **依存**: Task 4.1.6, Task 4.1.7
- **推定時間**: 10時間
- **ブランチ**: `feature/backup-manager`

#### Task 4.4.4: PrivacyManager・セキュリティ強化

- [ ] 個人情報検出・マスキング機能
- [ ] 機密情報パターン検出
- [ ] ローカル実行保証強化
- [ ] データ暗号化（必要時）
- [ ] セキュリティ監査ログ
- **完了条件**: プライバシー・セキュリティが確保されること
- **依存**: Task 4.2.1
- **推定時間**: 8時間
- **ブランチ**: `feature/privacy-manager`

#### Task 4.4.5: 統合テスト・品質検証

- [ ] Phase 4機能の包括的統合テスト
- [ ] パフォーマンス・負荷テスト
- [ ] API制限シナリオテスト
- [ ] データ整合性長期テスト
- [ ] ユーザビリティテスト
- **完了条件**: 全機能が本番レベルで安定動作すること
- **依存**: Task 4.4.1, Task 4.4.2, Task 4.4.3, Task 4.4.4
- **推定時間**: 12時間
- **ブランチ**: `test/phase4-integration`

#### Task 4.4.6: ドキュメント・リリース準備

- [ ] Phase 4機能ドキュメント作成
- [ ] API仕様書更新
- [ ] ユーザーマニュアル作成
- [ ] セットアップガイド更新
- [ ] OSS公開準備（README, CONTRIBUTING等）
- **完了条件**: 完全なドキュメントが整備されること
- **依存**: Task 4.4.5
- **推定時間**: 8時間
- **ブランチ**: `docs/phase4-documentation`

### 追加タスク（Phase 4.5: 拡張機能）

#### Task 4.5.1: /edit コマンド実装

- [ ] ノートID指定編集機能
- [ ] ファジー検索による編集対象選択
- [ ] インライン編集UI実装
- [ ] 編集履歴管理
- [ ] 変更差分表示
- **完了条件**: ノート編集が使いやすく動作すること
- **依存**: Task 4.2.3
- **推定時間**: 8時間
- **ブランチ**: `feature/edit-command`

#### Task 4.5.2: /review コマンド群実装

- [ ] /review daily - 日次レビュー機能
- [ ] /review weekly - 週次知識整理
- [ ] /review monthly - 月次成長分析
- [ ] カスタム期間レビュー機能
- [ ] レビュー結果可視化
- **完了条件**: 定期レビュー機能が実用的に動作すること
- **依存**: Task 4.2.3, Task 4.3.1
- **推定時間**: 10時間
- **ブランチ**: `feature/review-commands`

## 実装順序とブランチ戦略

### 並行実行可能なタスクグループ

1. **Phase 4.1 並行実行可能**:
   - Task 4.1.1, 4.1.2 (基盤設定)
   - Task 4.1.3 (データベース)
   - Task 4.1.7 (Railway設定) ※4.1.6完了後

2. **Phase 4.2 並行実行可能**:
   - Task 4.2.2, 4.2.5 (検索・リンク) ※4.2.1完了後
   - Task 4.2.3, 4.2.6 (UI・音声) ※4.2.1完了後

3. **Phase 4.3 並行実行可能**:
   - Task 4.3.1, 4.3.2 (統合・タグ付け)
   - Task 4.3.4, 4.3.5 (最適化・フォールバック)

4. **Phase 4.4 並行実行可能**:
   - Task 4.4.1, 4.4.2, 4.4.4 (監視・通知・セキュリティ)

### 依存関係のあるタスクのワークフロー

1. 全てのブランチは`main`の最新状態から作成
2. 依存先タスクのPRが`main`にマージされるまで待機
3. マージ後、作業ブランチで`git pull origin main`を実行
4. 最新の変更を取り込んでから開発開始

### クリティカルパス

**最短実装経路**: Task 4.1.1 → 4.1.2 → 4.1.3 → 4.1.5 → 4.1.6 → 4.1.8 → 4.2.1 → 4.2.2 → 4.2.3 → 4.2.4 → 4.4.5 → 4.4.6

## ブランチ命名規則

- **feature/**: 新機能実装 (例: `feature/knowledge-manager-core`)
- **refactor/**: リファクタリング (例: `refactor/service-container-phase4`)
- **test/**: テスト追加・改善 (例: `test/phase4-integration`)
- **ci/**: CI/CD・インフラ (例: `ci/railway-persistent-volumes`)
- **docs/**: ドキュメント (例: `docs/phase4-documentation`)

## リスクと対策

- **Railway永続化失敗**: Task 4.1.7で早期検証、フォールバック設計実装
- **Gemini API品質劣化**: Task 4.1.5でA/Bテスト、品質メトリクス監視
- **ChromaDBメモリ不足**: Task 4.3.4でメモリ使用量最適化、監視強化
- **データ同期不整合**: Task 4.1.8で整合性チェック自動化、修復機能
- **検索精度不足**: Task 4.2.4でRRFパラメータ調整、ユーザーフィードバック収集

## 注意事項

- 各タスクはコミット単位で完結させる
- タスク完了時は必要に応じて品質チェック（テスト、lint、typecheck）を実行
- 不明点は実装前に設計文書・統合設計書を確認
- ブランチ作成前に依存関係と並行実行可能性を確認
- Phase 4.1完了時点で基本的なPKM機能のプロトタイプが動作する状態を目指す

## 実装開始ガイド

### 開発ワークフロー
1. タスクリストに従って順次実装を進める
2. 各タスクの開始時にTodoWriteでin_progressに更新
3. 完了時はcompletedに更新
4. 問題発生時は速やかに報告

### ブランチ作成・運用手順
1. **ブランチ作成**: `git checkout -b [推奨ブランチ名] main`
2. **依存関係確認**: 依存タスクがmainにマージ済みか確認
3. **開発・コミット**: 頻繁に意味のあるコミットを作成
4. **PR作成**: 完了後はプルリクエストを作成
5. **マージ後**: 不要なローカルブランチを削除

### 注意事項
- 1タスク = 1ブランチ = 1PRの原則を遵守
- ブランチは短命に保つ（2-3日以内）
- 依存関係のあるタスクは順序を守る
- 並行実行可能なタスクは積極的に並行作業を推進

---

**作成日**: 2025-08-24
**対象期間**: Phase 4実装 (12週間)
**次ステップ**: Task 4.1.1から実装開始
