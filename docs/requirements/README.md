# 要件定義書 - NescordBot 統合システム仕様

## 概要

NescordBotは個人のナレッジ管理を「第二の脳」として機能させる Discord Bot です。Phase 1-3で構築した基盤の上に、Phase 4で高度な知識管理機能を追加し、完全なPersonal Knowledge Management (PKM) システムとして完成させます。

## システムアーキテクチャ

### 全体構成
```
Discord → SQLite(キュー+メタデータ) → GitHub(Obsidian-vault)
                ↓
          ChromaDB(ベクトル検索) ← Railway(ローカル検索システム)
```

### コンポーネント構成
- **Discord Bot**: ユーザーインターフェース (discord.py 2.3+)
- **SQLite**: メタデータ管理 + 処理キュー
- **ChromaDB**: ベクトル検索エンジン（インプロセス）
- **GitHub**: Obsidian Vault（マークダウンファイル保存）
- **Railway**: PaaSホスティング環境
- **Gemini API**: 音声・テキスト・Embedding処理

## 完成機能一覧

### Phase 1-3 完成機能（基盤）

#### 1. 音声処理機能
- [x] **音声メッセージ自動文字起こし**: OpenAI Whisper API統合
- [x] **AI内容整形**: GPT-3.5/4による要約・構造化
- [x] **Fleeting Note生成**: Discord→Obsidianマークダウン変換
- [x] **テンポラリファイル管理**: 安全なファイル処理・削除

#### 2. テキストメッセージ機能
- [x] **テキストからFleeting Note**: メッセージ内容の構造化・保存
- [x] **自動タイトル生成**: AI による適切なタイトル付与
- [x] **フロントマター生成**: Obsidian標準メタデータ自動設定

#### 3. GitHub/Obsidian統合
- [x] **自動リポジトリ同期**: ローカル→GitHubの自動プッシュ
- [x] **ブランチ管理**: 機能別ブランチの自動作成・マージ
- [x] **セキュリティ検証**: XSS・パストラバーサル対策
- [x] **バッチ処理**: 複数ファイルの効率的処理

#### 4. 基盤システム
- [x] **モジュラーCog設計**: 機能別分離とプラグイン対応
- [x] **包括的テスト**: 78%以上のカバレッジ維持
- [x] **CI/CD自動化**: GitHub Actions + Railway自動デプロイ
- [x] **構造化ログ**: 運用監視とデバッグ支援
- [x] **設定管理**: 環境別設定とバリデーション

#### 5. 管理・運用機能
- [x] **診断コマンド**: システム状態の確認・監視
- [x] **ログ閲覧**: リアルタイムログの参照機能
- [x] **データベース統計**: SQLite使用状況の可視化
- [x] **エラーハンドリング**: 堅牢な例外処理とリカバリ

### Phase 4 追加機能（知識管理）

#### 1. 知識検索システム
- [ ] **ベクトル検索**: ChromaDB統合による意味的検索
- [ ] **ハイブリッド検索**: ベクトル + キーワード検索の統合
- [ ] **検索コマンド**: `/search [キーワード]`で高精度検索
- [ ] **類似度スコアリング**: 検索結果の関連度表示
- [ ] **ローカルキャッシュ**: Railway環境での高速検索

#### 2. Permanent Note作成支援
- [ ] **類似ノート発見**: 自動的な関連ノート検出
- [ ] **統合提案**: 類似ノート群の統合可能性評価
- [ ] **`/merge`コマンド**: 複数Fleeting Noteの自動統合
- [ ] **AI統合サマリー**: LLMによる統合コンテンツ生成
- [ ] **自動リンク生成**: Obsidian内リンクの自動作成

#### 3. レビュー・インテリジェンス機能
- [ ] **定期レビュー**: `/review daily|weekly|monthly`
- [ ] **ファクトチェック**: WebSearch統合による情報検証
- [ ] **アイデア競合分析**: 既存ノートとの差異・類似性分析
- [ ] **知識品質向上**: 古い情報の更新提案・信頼性評価

#### 4. API統合・最適化
- [ ] **Gemini API完全移行**: OpenAI→Gemini移行による大幅コスト削減
- [ ] **無料枠活用**: 月100万トークン無料枠の最大活用
- [ ] **使用量監視**: リアルタイム使用量ダッシュボード
- [ ] **段階的制限**: API制限時の機能優先度別停止

#### 5. フォールバック・堅牢性
- [ ] **ローカル代替機能**: API制限時の継続利用
- [ ] **スマートキャッシュ**: 重複処理の回避・効率化
- [ ] **緊急時手動モード**: 完全オフライン対応
- [ ] **自動復旧**: 月初の機能自動再開

## 技術仕様

### 開発環境
- **言語**: Python 3.11+
- **フレームワーク**: discord.py 2.3+
- **依存管理**: Poetry
- **データベース**: SQLite (メタデータ) + ChromaDB (ベクトル)
- **AI API**: Google Gemini API (音声・テキスト・Embedding)
- **バージョン管理**: Git + GitHub
- **デプロイ**: Railway PaaS
- **CI/CD**: GitHub Actions

### パフォーマンス要件
- **検索応答時間**: 3秒以内（95%ile）
- **検索精度**: 関連ノート発見率80%以上
- **稼働率**: 24/7 運用
- **同時処理**: 複数コマンドの並行実行対応

### セキュリティ
- **API認証**: Gemini/GitHub APIの安全な管理
- **データプライバシー**: 完全プライベート環境（第三者サービス非経由）
- **入力検証**: XSS・インジェクション攻撃対策
- **アクセス制御**: 個人Bot専用の厳密な権限管理

### コスト効率
- **運用コスト**: Gemini API無料枠による実質無料運用
- **保険制限**: 月$5上限設定（緊急時のみ使用）
- **最適化**: キャッシュとバッチ処理による効率化

## 品質基準

### テスト・品質管理
- **テストカバレッジ**: 78%以上維持
- **CI/CD成功率**: 100%継続
- **コード品質**: black, mypy, isort, flake8による自動チェック
- **セキュリティ**: 定期的な依存関係脆弱性監査

### 運用品質
- **エラー率**: < 1%
- **平均復旧時間**: < 30分
- **データ整合性**: SQLite-ChromaDB間の完全同期
- **バックアップ**: 日次自動バックアップ

## 開発・運用プロセス

### GitHub Workflow
- **ブランチ戦略**: feature/issue-number-description
- **コミット規約**: `type(scope): description (refs #issue-number)`
- **PR管理**: 自動テスト・レビュー・マージ
- **Issue管理**: 1 Issue = 1 Branch = 1 PR

### 継続的改善
- **週次レビュー**: パフォーマンス・エラー分析
- **月次更新**: 依存関係・セキュリティパッチ
- **四半期評価**: 機能・品質・コストの総合評価

## 将来展望

### OSS公開計画
- **Phase 5-6**: 個人最適化後のOSS準備
- **ドキュメント**: セットアップガイド・API仕様
- **コミュニティ**: GitHub Discussions・プラグインエコシステム
- **目標**: 数百人の個人ユーザーによるセルフホスト利用

### 技術的拡張性
- **マルチモーダル**: 画像・動画ノートの処理対応
- **ローカルLLM**: プライバシー・コスト最適化
- **他ツール連携**: Notion・Scrapbox等との統合
- **高度な知識グラフ**: セマンティック関係の深化

---

**最終更新**: 2025-08-24
**現在フェーズ**: Phase 4 開発準備
**完了率**: Phase 1-3 (100%), Phase 4 (設計完了・実装準備中)
**次ステップ**: 技術設計フェーズ（`/design`コマンド）
