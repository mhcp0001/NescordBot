# 要件定義書 - NescordBot Phase 4「自分の第二の脳を育てるBot」

## 1. 目的

Phase 1-3で構築した基盤（音声文字起こし、Fleeting Note作成、GitHub/Obsidian同期）を拡張し、個人のナレッジ管理を「第二の脳」として機能させる高度な知識管理Botを構築する。蓄積されたノートの検索・統合・レビューを通じて、創造的な思考と継続的な学習を支援する。

### 基本コンセプト
- **個人最適化**: 一番の利用者である開発者のために最適化
- **データ主権**: 完全にプライベートなGitHub/Obsidian環境での管理
- **成長する知識**: Fleeting NoteからPermanent Noteへの知識の昇華
- **実用性重視**: 毎日10回以上使いたくなる実用的な機能
- **無料運用重視**: Gemini API無料枠（月100万トークン）内での厳格な運用

### アーキテクチャ概要
```
Discord → SQLite(キュー+メタデータ) → GitHub(Obsidian-vault)
                ↓
          ChromaDB(ベクトル検索) ← Railway(ローカル検索システム)
```

### 役割分離
- **SQLite**: ノートのメタデータ（ID、作成日時、タグ等）とキュー管理
- **ChromaDB**: ノート内容のベクトル化と意味的検索
- **GitHub**: 最終的なObsidianマークダウンファイルの保存
- **Railway**: ローカルキャッシュでの高速検索実行環境

## 2. 機能要件

### 2.1 知識検索基盤（必須機能）

#### 2.1.1 ベクトル検索システム
- [ ] **ChromaDB統合（インプロセス・Railway環境）**
  - データベース永続化設定（Railway環境のローカルストレージ）
  - 非同期処理対応（run_in_executor使用）
  - SQLiteとの役割分離（メタデータ：SQLite、Embedding：ChromaDB）
  - 共通UUID による両DB間の確実な紐付け
  - GitHub同期によるローカルキャッシュ管理
  - **データ同期メカニズム（シンプル方式）**
    - 最終的整合性を許容した実装
    - 定期的な整合性チェック（1日1回）
    - 不整合検出時のChromaDB自動再構築機能
    - SQLiteをマスターデータソースとする復旧戦略

- [ ] **検索コマンド実装**
  - `/search [キーワード]` - 基本検索機能
  - ローカルキャッシュに対する高速検索
  - 類似度スコアリング表示
  - 検索結果のランキング機能
  - 検索履歴の保存

#### 2.1.2 ハイブリッド検索
- [ ] **多層検索アルゴリズム**
  - ベクトル検索（意味的類似性）
  - キーワード検索（SQLite FTS5活用）
  - RRF（Reciprocal Rank Fusion）による結果統合
  - 再ランキング機能（上位候補の精密評価）

### 2.2 Permanent Note作成支援（必須機能）

#### 2.2.1 類似ノート発見・クラスタリング
- [ ] **自動類似ノート検出**
  - 新規Fleeting Note作成時の関連ノート自動検索
  - 類似度閾値による関連ノート群の特定
  - クラスタリング結果の可視化

- [ ] **統合提案システム**
  - 類似ノート群の統合可能性評価
  - ユーザーへの統合提案通知
  - 統合対象の選択インターフェース

#### 2.2.2 AI支援統合機能
- [ ] **`/merge` コマンド実装**
  - 複数Fleeting Noteの選択・統合
  - LLMによる統合サマリー生成
  - 矛盾点の検出と解消提案
  - Permanent Note草稿の自動生成

- [ ] **Obsidian連携強化**
  - 自動リンク生成
  - フロントマター自動設定
  - タグの統合・正規化

### 2.3 レビュー＆インテリジェンス機能（必須機能）

#### 2.3.1 定期レビューシステム
- [ ] **`/review` コマンド群**
  - `/review daily` - 今日のノートの振り返り
  - `/review weekly` - 週単位での知識整理
  - `/review monthly` - 月次での成長分析
  - カスタム期間でのレビュー機能

#### 2.3.2 知識品質向上機能
- [ ] **ファクトチェック機能**
  - WebSearch統合による情報検証
  - 外部情報源との照合
  - 古い情報の更新提案
  - 信頼性スコアリング

- [ ] **アイデア競合分析**
  - 類似アイデア・概念の検出
  - 既存ノートとの差異分析
  - 発展可能性の評価
  - 新規性の評価

### 2.4 コスト最適化機能（必須機能）

#### 2.4.1 API使用量管理
- [ ] **使用量ダッシュボード**
  - リアルタイム使用量表示
  - 月間コスト予測
  - サービス別使用量内訳
  - 使用パターン分析

- [ ] **コスト制限システム**
  - 月$5制限の厳格な実装
  - サーキットブレーカー機能
  - 使用量アラート通知
  - 緊急停止機能

#### 2.4.2 効率化機能
- [ ] **スマートキャッシュ**
  - 要約結果のキャッシュ
  - 検索結果のキャッシュ
  - 重複処理の回避
  - キャッシュの自動無効化

- [ ] **モデル使い分け**
  - タスク別最適モデル選択
  - コストパフォーマンス最適化
  - バッチ処理による効率化
  - ローカルWhisperオプション（実験的）

### 2.5 API制限時のフォールバック機能（必須機能）

#### 2.5.1 Gemini API無料枠管理（月100万トークン厳守）
- [ ] **厳格なトークン監視システム**
  - リアルタイムトークン使用量計測
  - 月間90%到達時の警告通知
  - 月間95%到達時の新機能停止
  - 月間100%到達時の全AI機能停止

- [ ] **段階的機能制限システム**
  - **90%到達**: 長文要約・複雑な検索を制限
  - **95%到達**: AI機能を必須操作のみに限定
  - **100%到達**: 全AI機能停止、手動モード移行
  - 月初の自動機能復旧（1日0時）

- [ ] **フォールバック機能**
  - **SQLiteメタデータ検索**: キーワード検索のみで継続
  - **手動ノート作成**: AI支援なしでの基本機能維持
  - **既存ノート閲覧**: ChromaDBキャッシュによる検索継続
  - **明確なユーザー通知**: 制限状況と復旧予定時刻の表示

### 2.6 Gemini API統合（必須機能）

- [ ] **OpenAI API から Gemini API への移行**
  - 音声文字起こし：Gemini 1.5 Pro（直接音声入力対応）
  - テキスト生成：Gemini 1.5 Flash（高速・低コスト）
  - Embedding：Gemini text-embedding-004
  - 無料枠の最大活用（月100万トークン）

- [ ] **API統合の段階的移行**
  - Week 1: Gemini API認証とテスト環境構築
  - Week 2-3: 音声処理の移行（OpenAI → Gemini）
  - Week 4-5: テキスト生成の移行
  - Week 6: Embedding生成の移行

### 2.7 PKM標準機能（必須機能）

#### 2.7.1 ノート管理機能
- [ ] **ノート編集・更新機能**
  - Discord経由でのノート内容修正
  - `/edit [ノートID]` コマンドによる編集
  - 編集履歴の保持（最大5版）
  - 編集時の自動GitHub同期

- [ ] **ノート間リンク機能**
  - Obsidian互換のマークダウンリンク記法 `[[ノート名]]`
  - 双方向リンクの自動生成・更新
  - リンク先ノートの自動提案
  - リンクグラフの可視化（簡易版）

#### 2.7.2 整理・分類機能
- [ ] **タグ管理システム**
  - `#タグ名` 記法による分類
  - タグによるノート絞り込み検索
  - タグの階層化（`#プロジェクト/機能` 形式）
  - 未使用タグの自動削除提案

- [ ] **データ管理機能**
  - ノート一覧表示（`/list` コマンド）
  - ノートのマークダウンエクスポート
  - GitHub経由での完全バックアップ
  - ノート統計情報の表示

### 2.8 個人用UI/UX改善（オプション機能）

- [ ] **カスタマイズ機能**
  - 個人用プロンプト設定
  - コマンドエイリアス設定
  - 出力フォーマット選択
  - ワンクリック設定ウィザード

- [ ] **運用支援機能**
  - 使用統計レポート
  - 設定の同期機能
  - システム診断機能

## 3. 非機能要件

### 3.1 パフォーマンス

- **検索応答時間**: 3秒以内（95%ile）
- **検索精度**: 関連ノートの発見率80%以上
- **同時処理**: 複数コマンドの並行実行対応
- **メモリ使用量**: Bot本体への影響最小化

### 3.2 信頼性

- **データ整合性**: SQLite-ChromaDB間のデータ同期保証
- **障害復旧**: ChromaDBインデックス自動再構築
- **バックアップ**: 知識ベース定期バックアップ
- **データ移行**: Phase 3からのスムーズな移行

### 3.3 セキュリティ

- **API認証**: Gemini/GitHub APIの安全な管理
- **データプライバシー**: 第三者サービスを経由しないデータ処理
- **アクセス制御**: 個人Bot専用の厳密な権限管理
- **監査ログ**: 重要操作の記録・追跡

### 3.4 保守性

- **モジュラー設計**: 機能別Cogによる分離
- **テスト可能性**: 包括的テストスイートの維持
- **ドキュメント**: 利用者・開発者向け詳細ドキュメント
- **OSS準備**: 将来的な公開を意識した設計

## 4. 制約事項

### 4.1 技術的制約

- **既存基盤継承**: Phase 1-3の技術スタック継続使用
- **Python 3.11+**: 現行バージョンの継続
- **discord.py 2.3+**: 既存Discord連携の維持
- **SQLite + ChromaDB**: インプロセス構成による制約
- **Railway PaaS**: デプロイ環境の継続使用

### 4.2 運用制約

- **コスト戦略**: Gemini API無料枠（月100万トークン）厳守、超過時は機能制限で対応
- **レスポンス性**: Discord Botとしての応答性維持（検索3秒以内）
- **データ量**: 個人使用レベルでのスケーラビリティ（年間1000ノート想定）
- **可用性**: 24/7稼働要求、ただしAPI制限時は基本機能のみ継続
- **API依存**: Gemini API制限時のフォールバック必須実装
- **データ整合性**: 最終的整合性モデル、定期的な自動修復に依存

### 4.3 開発制約

- **開発期間**: 12週間での段階的実装（品質重視）
- **リソース**: 個人開発プロジェクトとしての制約
- **互換性**: 既存機能への影響最小化
- **品質**: 78%以上のテストカバレッジ維持
- **技術的複雑性**: シンプルな実装を優先、過度な最適化は避ける

## 5. 成功基準

### 5.1 機能完了の定義

- [ ] ChromaDBベクトル検索の安定動作
- [ ] `/search`, `/merge`, `/review`コマンドの実装完了
- [ ] ハイブリッド検索による高精度検索の実現
- [ ] Gemini API への完全移行完了
- [ ] API制限時のフォールバック機能実装
- [ ] 既存機能との完全互換性維持

### 5.2 品質基準

- [ ] **検索精度**: 関連ノート発見率80%以上
- [ ] **応答性能**: 検索コマンド3秒以内レスポンス
- [ ] **コスト効率**: Gemini API無料枠での運用実証
- [ ] **テストカバレッジ**: 78%以上の維持
- [ ] **CI/CD成功率**: 100%の継続維持

### 5.3 実用性評価

- [ ] **日常使用**: 開発者が毎日10回以上使用
- [ ] **知識成長**: Fleeting→Permanent変換の実用例創出
- [ ] **発見効率**: 既存ノートからの新たな洞察発見
- [ ] **満足度**: 「第二の脳」として機能する実感

### 5.4 OSS準備度

- [ ] **ドキュメント完備**: セットアップガイド、API仕様
- [ ] **コード品質**: 他者が理解・拡張可能なレベル
- [ ] **設定簡易化**: 5分以内でのセットアップ実現
- [ ] **運用実績**: 3ヶ月以上の安定運用実績

## 6. 想定されるリスク

### 6.1 技術的リスク

- **ChromaDB統合の複雑性**: インプロセス統合時のリソース競合
  - 対策: 非同期処理の徹底、リソース監視の実装

- **検索精度の低下**: ベクトル検索の期待値未達成
  - 対策: ハイブリッド検索、モデル比較検証、チューニング

- **API費用の超過**: 想定以上のコスト発生
  - 対策: 厳格な制限機能、詳細な使用量監視

### 6.2 運用リスク

- **データ破損・不整合**: SQLite-ChromaDB間の同期問題
  - 対策: 定期的な整合性チェック、自動修復機能

- **パフォーマンス劣化**: 大量データ蓄積による性能低下
  - 対策: インデックス最適化、古いデータのアーカイブ

### 6.3 開発リスク

- **スコープクリープ**: 機能要求の際限ない拡大
  - 対策: MVP思想の徹底、段階的実装

- **品質担保の困難**: 複雑性増加による品質低下
  - 対策: 継続的テスト、段階的リファクタリング

## 7. 実装計画（12週間）

### Week 1-3: 基盤強化 + Gemini API移行
**目標**: 堅牢な基盤構築とAPI移行

- [ ] **Week 1: ChromaDB/SQLite統合基盤**
  - ChromaDBのインプロセス統合（Railway環境）
  - 共通UUID システム実装
  - SQLite-ChromaDB間の基本同期メカニズム
  - データ整合性チェック機能の実装

- [ ] **Week 2: Gemini API移行**
  - Gemini API認証とテスト環境構築
  - 音声処理の段階的移行（OpenAI → Gemini 1.5 Pro）
  - トークン使用量監視システム実装
  - 基本的なフォールバック機能

- [ ] **Week 3: 基本検索機能**
  - `/search`コマンドの基本実装
  - Gemini Embedding APIでのベクトル化
  - ハイブリッド検索の基礎実装
  - 非同期処理対応（run_in_executor）

**成果物**: 堅牢なGemini統合ベクトル検索基盤

### Week 4-6: PKM標準機能の実装
**目標**: ノート管理・編集・整理機能の完成

- [ ] **Week 4: ノート編集機能**
  - `/edit`コマンドの実装
  - ノート内容の更新機能
  - 編集履歴の管理（最大5版）
  - GitHub自動同期の強化

- [ ] **Week 5: リンク・タグ機能**
  - Obsidian互換リンク記法 `[[ノート名]]` 実装
  - 双方向リンクの自動生成
  - タグシステム（`#タグ名`）実装
  - タグによる絞り込み検索

- [ ] **Week 6: データ管理機能**
  - `/list`コマンド（ノート一覧）
  - マークダウンエクスポート機能
  - ノート統計情報表示
  - リンクグラフ可視化（簡易版）

**成果物**: 完全なPKM標準機能セット

### Week 7-9: 高度な知識管理機能
**目標**: AI支援による知識統合・レビュー機能

- [ ] **Week 7: Note統合機能**
  - 類似ノートのクラスタリング機能
  - `/merge`コマンド実装（Gemini Flash使用）
  - AI統合サマリー生成
  - 統合提案システム

- [ ] **Week 8: レビュー機能**
  - `/review`コマンド群（daily/weekly/monthly）
  - 定期的な知識振り返り機能
  - ファクトチェック機能（WebSearch統合）
  - アイデア競合分析

- [ ] **Week 9: フォールバック機能強化**
  - 段階的機能制限システム（90%/95%/100%）
  - SQLiteメタデータ検索モード
  - 制限状況の明確な通知機能
  - 月初自動復旧システム

**成果物**: AI支援知識管理システム + 堅牢なフォールバック

### Week 10-11: 最適化・性能向上
**目標**: 無料枠内での効率運用とパフォーマンス最適化

- [ ] **Week 10: トークン最適化**
  - Gemini使用量ダッシュボード実装
  - 効率的なトークン使用戦略
  - スマートキャッシュシステム
  - バッチ処理による効率化

- [ ] **Week 11: パフォーマンス調整**
  - レスポンス時間の最適化（3秒以内保証）
  - ChromaDBインデックスの調整
  - 並行処理の効率化
  - メモリ使用量の最適化

**成果物**: 無料枠内最適化済みシステム

### Week 12: 統合テスト・ドキュメント整備
**目標**: 品質保証とOSS公開準備

- [ ] **品質保証**
  - 包括的な統合テスト実行
  - データ整合性の最終検証
  - パフォーマンステスト（負荷・レスポンス時間）
  - セキュリティテスト

- [ ] **ドキュメント整備**
  - セットアップガイドの作成
  - API仕様書の整備
  - トラブルシューティングガイド
  - 使用例・ベストプラクティス集

- [ ] **OSS公開準備**
  - コード品質の最終チェック
  - ライセンス・README整備
  - GitHub Releases準備
  - デモ環境構築

**成果物**: OSS公開可能な高品質「第二の脳」Bot

## 8. 今後の検討事項

### 8.1 技術的拡張可能性

- **マルチモーダル対応**: 画像・動画ノートの処理
- **ローカルLLM統合**: コスト削減とプライバシー向上
- **高度な知識グラフ**: セマンティック関係の深化
- **他ツール連携**: Notion、Scrapbox等との統合

### 8.2 OSS戦略

- **コミュニティ形成**: GitHub Discussionsでのユーザー交流
- **プラグインシステム**: サードパーティ拡張の支援
- **ドキュメントサイト**: 専用ドキュメントサイトの構築
- **デモ環境**: オンラインでの体験環境提供

### 8.3 長期ビジョン

- **1年後**: 数百人の個人ユーザーによるセルフホスト利用
- **2年後**: 活発なOSSコミュニティの確立
- **3年後**: PKM（Personal Knowledge Management）ツールの標準の一つとして認知

---

**作成日**: 2025-08-24
**対象期間**: Phase 4（12週間実装計画）
**次フェーズ**: 技術設計フェーズ（`/design`コマンド）
