# タスクリスト - NescordBot 開発・運用基盤整備

## 概要

- 総タスク数: 48
- 推定作業時間: 8週間（各Phase 2週間）
- 優先度: 高（基盤構築）

## タスク一覧

### Phase 1: MVP基盤 + 最初の機能（2週間）

#### Task 1.1: プロジェクト初期設定
- [ ] プロジェクト構造の作成（src/, tests/, docs/）
- [ ] .env.exampleファイルの作成
- [ ] .gitignoreの更新（.env, *.log, __pycache__/）
- [ ] README.mdの基本手順作成
- **完了条件**: プロジェクト構造が整い、環境変数サンプルが用意される
- **依存**: なし
- **推定時間**: 1時間

#### Task 1.2: Poetry環境構築
- [ ] pyproject.tomlの作成（Python 3.11+指定）
- [ ] 基本依存関係の追加（discord.py, python-dotenv, pydantic）
- [ ] 開発依存関係の追加（pytest, black, flake8, mypy）
- [ ] poetry.lockの生成
- **完了条件**: Poetry環境で依存関係がインストール可能
- **依存**: Task 1.1
- **推定時間**: 1時間

#### Task 1.3: ConfigManagerの実装
- [ ] src/config.pyの作成
- [ ] Pydanticを使用したBotConfig modelの定義
- [ ] .envからの環境変数読み込み
- [ ] バリデーション処理の実装
- **完了条件**: 環境変数が正しく読み込まれ、型検証される
- **依存**: Task 1.2
- **推定時間**: 2時間

#### Task 1.4: LoggerServiceの実装
- [ ] src/logger.pyの作成
- [ ] 標準loggingの設定（コンソール + ファイル出力）
- [ ] ログレベルの環境変数制御
- [ ] フォーマッタの設定
- **完了条件**: 構造化されたログが出力される
- **依存**: Task 1.3
- **推定時間**: 1時間

#### Task 1.5: BotCoreの基本実装
- [ ] src/bot.pyの作成
- [ ] NescordBotクラスの実装（commands.Bot継承）
- [ ] setup_hookメソッドの実装
- [ ] on_readyイベントハンドラ
- [ ] グローバルエラーハンドラ（on_error, on_command_error）
- **完了条件**: Botが起動し、基本的なイベントを処理できる
- **依存**: Task 1.3, Task 1.4
- **推定時間**: 3時間

#### Task 1.6: GeneralCogの実装
- [ ] src/cogs/general.pyの作成
- [ ] pingコマンドの実装
- [ ] helpコマンドのカスタマイズ
- [ ] statusコマンドの実装（Bot情報表示）
- **完了条件**: 基本コマンドが動作する
- **依存**: Task 1.5
- **推定時間**: 2時間

#### Task 1.7: 起動スクリプトの作成
- [ ] run.pyまたはmain.pyの作成
- [ ] ServiceContainerの基本実装
- [ ] 非同期メイン関数の実装
- [ ] グレースフルシャットダウンの実装
- **完了条件**: poetry run python run.pyでBot起動
- **依存**: Task 1.5, Task 1.6
- **推定時間**: 2時間

#### Task 1.8: 基本的なテストの作成
- [ ] tests/conftest.pyの作成（pytest fixtures）
- [ ] tests/test_config.pyの作成
- [ ] tests/test_general_cog.pyの作成
- [ ] モックコンテキストの実装
- **完了条件**: 基本的なユニットテストがパスする
- **依存**: Task 1.6
- **推定時間**: 3時間

#### Task 1.9: GitHub Actions CI設定
- [ ] .github/workflows/ci.ymlの作成
- [ ] Pythonセットアップ
- [ ] Poetry依存関係インストール
- [ ] pytest実行
- [ ] コード品質チェック（black, flake8）
- **完了条件**: PRでCIが自動実行される
- **依存**: Task 1.8
- **推定時間**: 2時間

#### Task 1.10: Railway手動デプロイ準備
- [ ] requirements.txt生成（poetry export）
- [ ] Procfileの作成
- [ ] runtime.txtの作成（Python 3.11）
- [ ] Railway設定ドキュメント作成
- **完了条件**: Railwayにデプロイ可能な状態
- **依存**: Task 1.7
- **推定時間**: 2時間

### Phase 2: 開発基盤強化 + 機能追加（2週間）

#### Task 2.1: DatabaseService設計
- [ ] src/services/__init__.pyの作成
- [ ] IDataStore抽象基底クラスの定義
- [ ] SqliteDataStoreクラスの設計
- [ ] エラーハンドリング設計
- **完了条件**: データストア抽象化レイヤーが定義される
- **依存**: Phase 1完了
- **推定時間**: 2時間

#### Task 2.2: aiosqlite実装
- [ ] aiosqlite依存関係追加
- [ ] SqliteDataStoreの実装
- [ ] Key-Value操作メソッド（get, set, delete）
- [ ] JSON操作メソッド（get_json, set_json）
- [ ] 接続プール管理
- **完了条件**: 非同期でデータ永続化が可能
- **依存**: Task 2.1
- **推定時間**: 3時間

#### Task 2.3: データベースマイグレーション
- [ ] migrations/ディレクトリ構造作成
- [ ] 初期スキーマSQL作成
- [ ] マイグレーション実行スクリプト
- [ ] バージョン管理システム
- **完了条件**: データベース構造の変更が管理される
- **依存**: Task 2.2
- **推定時間**: 2時間

#### Task 2.4: ServiceContainerの拡張
- [ ] DatabaseServiceの統合
- [ ] 起動時の初期化処理
- [ ] シャットダウン時のクリーンアップ
- [ ] 依存性注入の実装
- **完了条件**: 全サービスが適切に管理される
- **依存**: Task 2.2
- **推定時間**: 2時間

#### Task 2.5: テスト基盤の強化
- [ ] pytest-asyncioの設定最適化
- [ ] pytest-mockの統合
- [ ] pytest-covの設定（カバレッジ60%目標）
- [ ] テスト用DBフィクスチャ
- **完了条件**: 非同期テストが安定して実行される
- **依存**: Task 2.4
- **推定時間**: 3時間

#### Task 2.6: コード品質ツール統合
- [ ] blackの設定（pyproject.toml）
- [ ] flake8の設定（.flake8）
- [ ] isortの設定
- [ ] mypyの設定（mypy.ini）
- [ ] pre-commitフックの設定
- **完了条件**: コード品質が自動チェックされる
- **依存**: なし
- **推定時間**: 2時間

#### Task 2.7: ログ閲覧コマンドの実装
- [ ] src/cogs/admin.pyの作成
- [ ] logsコマンドの実装（最新ログ表示）
- [ ] ログレベルフィルタリング
- [ ] ページネーション機能
- **完了条件**: Discord上でログが確認できる
- **依存**: Task 2.4
- **推定時間**: 3時間

#### Task 2.8: 設定管理コマンドの実装
- [ ] configコマンドの実装（設定表示）
- [ ] setconfigコマンドの実装（設定変更）
- [ ] 設定永続化（DatabaseService使用）
- [ ] 権限チェック機能
- **完了条件**: Discord上で設定が管理できる
- **依存**: Task 2.7
- **推定時間**: 3時間

#### Task 2.9: DatabaseServiceのテスト
- [ ] tests/test_database_service.pyの作成
- [ ] 基本操作のテスト
- [ ] エラーケースのテスト
- [ ] 同時実行テスト
- **完了条件**: DatabaseServiceのカバレッジ80%以上
- **依存**: Task 2.5
- **推定時間**: 2時間

#### Task 2.10: 統合テストの追加
- [ ] tests/integration/test_bot_lifecycle.pyの作成
- [ ] Bot起動・終了テスト
- [ ] コマンド実行テスト
- [ ] エラーハンドリングテスト
- **完了条件**: End-to-Endテストがパスする
- **依存**: Task 2.9
- **推定時間**: 3時間

### Phase 3: GitHub連携機能 + CD導入（2週間）

#### Task 3.1: GitHubService設計
- [ ] src/services/github.pyの作成
- [ ] IGitHubService抽象基底クラス
- [ ] データモデル定義（PR, Branch, Commit）
- [ ] カスタム例外クラス定義
- **完了条件**: GitHub API操作の抽象化層が定義される
- **依存**: Phase 2完了
- **推定時間**: 2時間

#### Task 3.2: aiohttp実装
- [ ] aiohttp, aiocache依存関係追加
- [ ] HTTPクライアントセッション管理
- [ ] 基本的なAPI呼び出しメソッド
- [ ] エラーハンドリング
- **完了条件**: 非同期でGitHub APIを呼び出せる
- **依存**: Task 3.1
- **推定時間**: 3時間

#### Task 3.3: レート制限管理
- [ ] レート制限チェック機能
- [ ] 429エラーのリトライ処理
- [ ] 指数バックオフ実装
- [ ] レート制限状態の監視
- **完了条件**: APIレート制限を超えない
- **依存**: Task 3.2
- **推定時間**: 3時間

#### Task 3.4: キャッシュ戦略実装
- [ ] ETagベースのキャッシュ
- [ ] 条件付きリクエスト（304処理）
- [ ] TTLベースのメモリキャッシュ
- [ ] キャッシュ無効化処理
- **完了条件**: API呼び出しが最小化される
- **依存**: Task 3.3
- **推定時間**: 3時間

#### Task 3.5: PR作成機能の実装
- [ ] create_prメソッドの実装
- [ ] create_branchメソッドの実装
- [ ] commit_filesメソッドの実装
- [ ] ファイルツリー操作
- **完了条件**: プログラムからPRが作成できる
- **依存**: Task 3.4
- **推定時間**: 4時間

#### Task 3.6: GitHubCogの実装
- [ ] src/cogs/github.pyの作成
- [ ] pr_createコマンド
- [ ] repo_infoコマンド
- [ ] エラーメッセージのユーザーフレンドリー化
- **完了条件**: Discord経由でGitHub操作が可能
- **依存**: Task 3.5
- **推定時間**: 3時間

#### Task 3.7: Obsidian連携機能
- [ ] Obsidian Vault構造の定義
- [ ] Fleeting noteテンプレート作成
- [ ] フロントマター生成処理
- [ ] ファイル命名規則実装
- **完了条件**: Obsidian形式のMarkdownが生成される
- **依存**: Task 3.6
- **推定時間**: 3時間

#### Task 3.8: Railway CD設定
- [ ] .github/workflows/deploy.ymlの作成
- [ ] Railway CLI設定
- [ ] 環境変数管理
- [ ] デプロイメントトリガー設定
- **完了条件**: mainブランチプッシュで自動デプロイ
- **依存**: なし
- **推定時間**: 2時間

#### Task 3.9: GitHubServiceのテスト
- [ ] tests/test_github_service.pyの作成
- [ ] モックGitHub APIレスポンス
- [ ] レート制限テスト
- [ ] キャッシュテスト
- **完了条件**: GitHubServiceカバレッジ80%以上
- **依存**: Task 3.5
- **推定時間**: 3時間

#### Task 3.10: 統合テスト（GitHub機能）
- [ ] End-to-End PR作成テスト
- [ ] エラーリカバリーテスト
- [ ] 並行実行テスト
- [ ] 実際のテストリポジトリでの検証
- **完了条件**: GitHub連携が安定動作する
- **依存**: Task 3.9
- **推定時間**: 3時間

### Phase 4: 運用基盤完成 + 本格運用（2週間）

#### Task 4.1: VoiceCog設計
- [ ] src/cogs/voice.pyの構造設計
- [ ] OpenAI API統合設計
- [ ] 音声ファイル処理フロー設計
- [ ] エラーハンドリング設計
- **完了条件**: 音声処理アーキテクチャが定義される
- **依存**: Phase 3完了
- **推定時間**: 2時間

#### Task 4.2: OpenAI API統合
- [ ] openai依存関係追加
- [ ] Whisper API呼び出し実装
- [ ] GPT API呼び出し実装
- [ ] レート制限とエラー処理
- **完了条件**: OpenAI APIが利用可能
- **依存**: Task 4.1
- **推定時間**: 3時間

#### Task 4.3: 音声メッセージ処理
- [ ] 音声ファイルダウンロード処理
- [ ] 一時ファイル管理
- [ ] Whisper文字起こし実装
- [ ] GPT整形処理実装
- **完了条件**: 音声が文字起こしされる
- **依存**: Task 4.2
- **推定時間**: 4時間

#### Task 4.4: ヘルスチェック実装
- [ ] /healthエンドポイント設計
- [ ] 簡易HTTPサーバー実装
- [ ] システム状態チェック
- [ ] Railway統合
- **完了条件**: 外部監視が可能
- **依存**: なし
- **推定時間**: 2時間

#### Task 4.5: メトリクス収集
- [ ] 実行時間記録
- [ ] エラー率計測
- [ ] メモリ使用量監視
- [ ] ログへの出力
- **完了条件**: パフォーマンスが可視化される
- **依存**: Task 4.4
- **推定時間**: 3時間

#### Task 4.6: ドキュメント整備
- [ ] APIドキュメント生成
- [ ] デプロイメントガイド作成
- [ ] トラブルシューティングガイド
- [ ] コントリビューションガイド
- **完了条件**: 開発者向けドキュメント完備
- **依存**: なし
- **推定時間**: 4時間

#### Task 4.7: パフォーマンス最適化
- [ ] 非同期処理の最適化
- [ ] メモリリーク調査
- [ ] キャッシュ戦略の調整
- [ ] データベースインデックス最適化
- **完了条件**: 応答時間が目標値以内
- **依存**: Task 4.5
- **推定時間**: 3時間

#### Task 4.8: セキュリティ強化
- [ ] 入力検証の強化
- [ ] ログマスキング実装
- [ ] 権限管理の徹底
- [ ] セキュリティ監査
- **完了条件**: セキュリティ脆弱性がない
- **依存**: なし
- **推定時間**: 3時間

#### Task 4.9: 本番環境テスト
- [ ] 負荷テスト実施
- [ ] 障害復旧テスト
- [ ] バックアップ・リストアテスト
- [ ] モニタリング動作確認
- **完了条件**: 本番運用の準備完了
- **依存**: Task 4.7, Task 4.8
- **推定時間**: 3時間

#### Task 4.10: リリース準備
- [ ] バージョンタグ付け
- [ ] リリースノート作成
- [ ] デプロイメントチェックリスト
- [ ] 運用手順書の最終確認
- **完了条件**: v1.0.0リリース可能
- **依存**: Task 4.9
- **推定時間**: 2時間

## 実装順序

1. Phase 1から順次実行（基盤なしに機能追加は不可能）
2. 各Phase内では依存関係に従って実装
3. テストは各機能実装直後に作成
4. CI/CDは早期に構築して継続的に活用

## リスクと対策

- **データ永続性問題（Railway/Heroku）**: Phase 2でRedis対応を検討
- **GitHub APIレート制限**: キャッシュとETag活用で最小化
- **非同期リソース管理**: ServiceContainerパターンで一元管理
- **テストの複雑化**: モックとフィクスチャで簡潔に保つ

## 注意事項

- 各タスクは1つのPRで完結させる
- コミットメッセージは conventional commits 形式
- テストが通らないコードはマージしない
- 不明点は実装前にIssueで議論する

## 実装開始ガイド

1. このタスクリストに従って順次実装を進めてください
2. 各タスクの開始時にTodoWriteでin_progressに更新
3. 完了時はcompletedに更新
4. 問題発生時は速やかに報告してください
5. 1日の作業開始時に進捗を確認し、計画を調整してください